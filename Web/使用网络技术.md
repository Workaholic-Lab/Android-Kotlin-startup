# 使用网络技术

> Gary哥哥的哥哥
>
> 2021.2.26

> 这里我们使用网络技术丰富我们的应用程序，本章节主要讲解如何**在手机端使用HTTP和服务器进行网络交互，并对服务器返回的数据进行解析**

## WebView的用法

> 有时候我们有一些特殊的需求，比如在应用程序当中展示一些网页
>
> * 这里就要使用到WebView这个空间了

很简单的：

```xml
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    xmlns:tools="http://schemas.android.com/tools"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    tools:context=".MainActivity"
    android:orientation="vertical">

    <WebView
        android:layout_width="match_parent"
        android:layout_height="match_parent"
        android:id="@+id/webView"/>

</LinearLayout>
```

```kotlin
package com.workaholiclab.webviewtest

import androidx.appcompat.app.AppCompatActivity
import android.os.Bundle
import android.webkit.WebViewClient
import kotlinx.android.synthetic.main.activity_main.*

class MainActivity : AppCompatActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)
        webView.settings.javaScriptEnabled = true
        webView.webViewClient = WebViewClient()
        webView.loadUrl("https://1.semantic-ui.com/")

    }
}
```

> **最后记得注册哦！**

```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.workaholiclab.webviewtest">

    <uses-permission android:name="android.permission.INTERNET"/>
    <application
        android:allowBackup="true"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:supportsRtl="true"
        android:theme="@style/AppTheme">
        <activity android:name=".MainActivity">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />

                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
    </application>

</manifest>
```

> 只要确保你的计算机可以上网就可以用模拟器弹出这个网址

> **下面我们需要对HTTP协议做一些真正的网络开发工作了！**

## 使用HTTP访问网络

> 这里HTTP全部的原理或许你要学习计算机网络专业课程或者网络开发才能学会，但这里作为Android开发，我们只会简单介绍。
>
> * **==不求甚解==**

> 前面其实就是我们像那个网站发出了一条HTTP的请求，它把网页的html代码返回回来，显示在我们的APP上

> 接下来我们重点看看通过手动发送HTTP请求的方式，更加深入地理解这个过程

### 使用HttpURLConnection

> 在android上面发送HTTP请求一般有两种方法，HttpURLConnection和HttpClient，不过由于后者的API过多，扩展过于困难，现在都一般建议我们用前者

* 首先，获取HttpUrlConnection实例，一般这需要创建一个URL对象，并且出传入目标的网络地址，然后调用一下openConnection()方法即可。

```kotlin
val url = URL("https://www.baidu.com/")
val connection = url.openConnection() as HttpURLConnection
```

* 在得到HttpURLConnection的实例之后，我们可以设置一下HTTP的请求方法，常用的是GET和POST
  * Get代表想获取数据
  * POST想提交数据

```kotlin
connection.requestMethod = "GET"
```

* 接下来就可以进行一些自由的定制了
  * 比如设置连接超时
  * 读取超时的毫秒数
  * 以及服务器希望的到的一些消息

```kotlin
connection.connectionTimeout = 8000
connection.readTimeout = 8000
```

* 之后再调用getInputStream()方法就可以获取到服务器返回的输入流，剩下的任务就是对输入流进行读取

```kotlin
val input = connection.inputStream
```

* 最后关闭这个连接

```kotlin
connection.disconnect()
```

> 下面新建一个项目来熟悉一下

别忘了注册先！！！

```xml
<uses-permission android:name="android.permission.INTERNET"/>
```

```xml
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    xmlns:tools="http://schemas.android.com/tools"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    tools:context=".MainActivity"
    android:orientation="vertical">

    <Button
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="Send Request"
        android:textAllCaps="false"
        android:id="@+id/sendRequestBtn"
        />

    <ScrollView
        android:layout_width="match_parent"
        android:layout_height="match_parent">
        <TextView
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:id="@+id/responseText"/>
    </ScrollView>

</LinearLayout>
```

```kotlin
package com.workaholiclab.networktest

import androidx.appcompat.app.AppCompatActivity
import android.os.Bundle
import kotlinx.android.synthetic.main.activity_main.*
import java.io.BufferedReader
import java.io.InputStreamReader
import java.lang.Exception
import java.lang.StringBuilder
import java.net.HttpURLConnection
import java.net.URL
import kotlin.concurrent.thread

class MainActivity : AppCompatActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)
        sendRequestBtn.setOnClickListener {
            sendRequestWithHttpURLConnection()
        }
    }

    private fun sendRequestWithHttpURLConnection() {
        //开启线程发起的网络请求
        thread {
            var connection: HttpURLConnection?=null
            try {
                val response = StringBuilder()
                val url = URL("https://www.baidu.com")
                connection = url.openConnection() as HttpURLConnection
                connection.connectTimeout=8000
                connection.readTimeout=8000
                val input = connection.inputStream
                //下面对获取到的输入流进行读取
                val reader = BufferedReader(InputStreamReader(input))
                reader.use {
                    reader.forEachLine {
                        response.append(it)

                    }
                }
                println(response.toString())
                showResponse(response.toString())
            }catch (e:Exception) {
                e.printStackTrace()
            }finally {
                connection?.disconnect()
            }
        }
    }

    private fun showResponse(response: String) {
        runOnUiThread{
            //在这里进行UI操作
            responseText.text = response
        }
    }
}
```

> **如果想要提交数据给服务器也很简单** **如下所示即可：**
>
> * 向服务器提交用户名和密码：

```kotlin
connection.requestMethod = "POST"
val output = DataOutputStream(connection.outputStream)
output.writeBytes("username=admin&password=123456")
```

**注意每条数据都要以KV对的形式存在，数据与数据之间用&隔开**



## 使用OkHTTP

> 在开源如此盛行的今天，OkHttp已经成为Android开发者网络通讯库的首选

* 添加依赖文件

```xml
implementation 'com.squareup.okhttp3:okhttp:4.1.0'
```

> 至于你看博客的时候OkHttp库最新版本是多少，可以访问它的github主页

> 全部步骤如下面代码所示

```kotlin
//创建实例
val client = OkHttpClient()
//发起一条Http请求，创建一个Request对象
//val request = Request.Builder().build()//这样子只能创建一个空的request，应该像下面一样：
//赋值
val request = Request.Builder().url("https://www.baidu.com").build()
//newCall()来创建一个Call对象
val response=client.newCall(request).execute()
//Request对象就是服务器返回的数据了，我们采用如下写法来得到返回的数据
val responseData=response.body?.string()

//如果是POST的话会麻烦一点点，如下：
//先构建Request Body对象来存放待提交的数据
val requestBody = FormBody.Builder().add("username","admin").add("password","123456").build()
//调用post方法将RequestBody对象传入
val requestPost=Request.Builder().url("https://www.baidu.com").post(requestBody).build()
//后面就和Get一样调用execute()方法来发送并请求获取服务器返回的数据即可
```

> 下面来对上面之前那个项目做修改，用OkHttp库来做

```kotlin
private fun sendRequestWithOkHttp() {
    thread {
        try {
            val client = OkHttpClient()
            val request = Request.Builder().url("https://www.baidu.com").build()
            val response = client.newCall(request).execute()
            val responseData= response.body?.string()
            if(responseData!=null){
                showResponse(responseData)
            }
        }catch (e:Exception){
            e.printStackTrace()
        }
    }
}

private fun showResponse(response: String) {
    runOnUiThread{
        //在这里进行UI操作
        responseText.text = response
    }
}
```





> 今天有点鼻炎，剩下的内容，以后补充完
>
> 可先自行看书



